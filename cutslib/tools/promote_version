#!/bin/env python

"""This script promotes the version of the cut parameter files.
It does the following job:
- Find the latest version and make a copy with version number 
  incremented. 
- Update the flatfield version

"""

import sys, os, glob

# get the version to update to
version = sys.argv[1]

# find the latest version
i_new = int(version[1:])
i = i_new-1
while i>=0:
    if not os.path.exists("cutparams_v%d.par" % i):
        i-=1
    else: 
        print("Found latest version v%d" % i)
        break
i_old = i

# create new cutparam
command = "sed -e 's/_v{}/_v{}/g' cutparams_v{}.par > cutparams_v{}.par".format(i_old, i_new, i_old, i_new)
print(command)
os.system(command)

# create new cutParam
with open("cutParams_v{}.par".format(i_old), "r") as f:
    lines = f.readlines()

for l in lines:
    if "flatfield" in l:
        if 'null' in l:
            # find flatfield file
            ff = glob.glob("ff*v0.dict")[0]
            command = "sed -e 's/ff.*dict/{}/' cutParams_v{}.par > cutParams_v{}.par".format(ff, i_old, i_new)
            print(command)
            os.system(command)
        elif 'dict' in l:
            # find flatfield file
            ff = glob.glob("ff*v{}.dict".format(i_old))[0]
            command = "sed -e 's/ff.*dict/{}/' cutParams_v{}.par > cutParams_v{}.par".format(ff, i_old, i_new)
            print(command)
            os.system(command)
